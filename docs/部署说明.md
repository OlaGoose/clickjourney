# Orbit Journey 部署说明（大白话版）

## 一、部署前要搞定的两件事

### 1. 数据库（Supabase）

- 去 [supabase.com](https://supabase.com) 建一个项目，记下 **Project URL** 和 **anon key**（在 Settings → API 里）。
- 在 Supabase 里把表建好：打开 **SQL Editor**，把项目里 `supabase/migrations/00000000000000_initial_schema.sql` 这个文件的**全部内容**复制进去，点运行。这样就会创建 `user_profiles`、`travel_memories` 两张表以及权限（RLS）。
- 如果要支持图片/音频/视频上传：在 Supabase 里打开 **Storage**，新建一个桶，名字必须是 **`memories`**，并勾选「公开」（Public），这样前端拿到的链接才能直接访问。

### 2. 环境变量

在你要部署的平台（比如 Vercel）里配置这些变量：

| 变量名 | 必填吗 | 说明 |
|--------|--------|------|
| `NEXT_PUBLIC_SUPABASE_URL` | 要上线登录和同步就必填 | Supabase 项目 URL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | 同上 | Supabase 的 anon 公钥 |
| `NEXT_PUBLIC_ENABLE_MOCK_AUTH` | 生产别开 | 留空或 `false`，否则不会用真实 Supabase 登录 |
| `NEXT_PUBLIC_ENABLE_DEMO_DATA` | 可选 | 只有做演示站时才设成 `true` |
| `NEXT_PUBLIC_GOOGLE_MAPS_API_KEY` | 可选 | 编辑器里选地点用 |
| `NEXT_PUBLIC_GEMINI_API_KEY` 等 | 可选 | AI 功能（生成剧本、转录等） |
| `GCS_BUCKET`、`GCS_SERVICE_ACCOUNT_JSON` | 可选 | 不用 Supabase 存文件时，用 Google 云存储上传媒体 |

**大白话**：  
- 想用**真实登录 + 数据同步**：必须配好 Supabase 两个变量，并且**不要**开 Mock Auth。  
- 想用**图片/音频/视频上传**：要么在 Supabase 建好 `memories` 公开桶，要么配 GCS。  
- 其他（地图、AI）按需配置即可。

---

## 二、怎么部署

### 方式 A：用 Vercel（推荐）

1. 代码推到 GitHub。
2. 打开 [vercel.com](https://vercel.com)，用 GitHub 登录，点「Import」把你的仓库导进来。
3. 在项目里打开 **Settings → Environment Variables**，把上面那些变量一条条加进去（Production 环境记得加）。
4. 点 **Deploy**（或推送代码自动部署）。等构建跑完，用「Visit」打开网址即可。

### 方式 B：自己服务器或别的平台

1. 在机器上装好 Node 20，拉代码，执行：
   ```bash
   npm install
   npm run build
   npm run start
   ```
2. 默认端口是 3000；如需改端口可设环境变量 `PORT=3000`（改成你要的端口）。
3. 环境变量在平台或 `.env` 里配好，同样**不要**在生产开 `NEXT_PUBLIC_ENABLE_MOCK_AUTH`。

---

## 三、部署后检查一下

1. 打开首页，用 Supabase 账号登录（先要在 Supabase Auth 里开邮箱登录或第三方登录）。
2. 新建一条记忆，写点内容、选个类型（富文本/相册/电影感等），保存。
3. 到 Supabase 的 **Table Editor → travel_memories** 里看，应该能看到刚建的那一行，且 `type`、`editor_blocks_json` 等字段有正常数据。

如果以上都正常，说明后端可用、数据在 Supabase 里存上了。

---

## 四、数据在哪里、会不会丢

- **读数据**：前端先从浏览器里的 IndexedDB 读（本地优先），登录且配了 Supabase 时，会后台和 Supabase 同步。
- **写数据**：新建/编辑先写进 IndexedDB，再在后台推到 Supabase，所以**只要 Supabase 配好了，数据在后端是有的**。
- **未登录**：没开 Demo 时列表是空的；开了 Demo 会往本地塞示例数据，这些示例**不会**被推到 Supabase（避免权限报错）。

更细的数据流、Sync 逻辑、类型对应关系见：`docs/DEPLOYMENT_AND_DATA_ANALYSIS.md`。
